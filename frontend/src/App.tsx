import React, { useState, useEffect, useCallback, useRef } from 'react';
import axios from 'axios';
import './App.css';
import { TelegramAuth } from './components/TelegramAuth';
import { v4 as uuidv4 } from 'uuid';

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π URL API
const API_BASE_URL = '';

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
const Loading = ({ message }: { message: string }) => (
  <div className="loading-indicator">
    <div className="loading-spinner"></div>
    <p>{message}</p>
  </div>
);

const ErrorMessage = ({ message, onClose }: { message: string | null, onClose: () => void }) => (
  <div className="error-message">
    <p>{message}</p>
    <button className="action-button small" onClick={onClose}>–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
);

const SuccessMessage = ({ message, onClose }: { message: string | null, onClose: () => void }) => (
  <div className="success-message">
    <p>{message}</p>
    <button className="action-button small" onClick={onClose}>–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
);

// Simple error boundary component
class SimpleErrorBoundary extends React.Component<
  { children: React.ReactNode },
  { hasError: boolean }
> {
  constructor(props: { children: React.ReactNode }) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError() {
    return { hasError: true };
  }

  render() {
    if (this.state.hasError) {
      return <div className="error-message">–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>;
    }
    return this.props.children;
  }
}

// –¢–∏–ø—ã –¥–ª—è typescript
declare global {
  interface Window {
    Telegram?: {
      WebApp?: any;
    };
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram WebApp —Å—Ä–∞–∑—É
try {
  if (window.Telegram?.WebApp) {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp...');
    window.Telegram.WebApp.ready();
  } else if (typeof (window as any).WebApp?.ready === 'function') {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp –∏–∑ SDK...');
    (window as any).WebApp.ready();
  }
} catch (e) {
  console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp:', e);
}

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø—ã –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
type ViewType = 'analyze' | 'suggestions' | 'plan' | 'details' | 'calendar' | 'edit';

// –¢–∏–ø –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞
interface AnalysisResult {
  message?: string;
  themes: string[];
  styles: string[];
  analyzed_posts_sample: string[];
  best_posting_time: string;
  analyzed_posts_count: number;
}

// –¢–∏–ø –¥–ª—è –∏–¥–µ–∏
interface SuggestedIdea {
  id: string;
  created_at: string;
  channel_name: string;
  topic_idea: string;
  format_style: string;
  day?: number;
  is_detailed?: boolean;
  user_id?: string;
}

// –¢–∏–ø –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
interface DetailedPost {
  post_text: string;
  images: PostImage[];
}

// –¢–∏–ø –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å—Ç–∞
interface PostImage {
  url: string;
  alt?: string;
  author?: string;
  author_url?: string;
}

// –¢–∏–ø –¥–ª—è –ø–ª–∞–Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π
interface PlanItem {
  day: number;
  topic_idea: string;
  format_style: string;
}

// –¢–∏–ø –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
interface SavedPost {
  id: string;
  user_id: string;
  created_at: string;
  updated_at: string;
  target_date: string;
  topic_idea: string;
  format_style: string;
  final_text: string;
  image_url?: string;
  channel_name?: string;
  images_ids?: string[]; // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –º–∞—Å—Å–∏–≤–∞ ID –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
}

// –¢–∏–ø –¥–ª—è –¥–Ω—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
interface CalendarDay {
  date: Date;
  posts: SavedPost[];
  isCurrentMonth: boolean;
  isToday: boolean;
}

// –î–æ–±–∞–≤–∏–º –Ω–æ–≤—ã–π —Ç–∏–ø –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π –ø–æ—Å—Ç–æ–≤
interface CachedPostDetails {
  [key: string]: DetailedPost;
}

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
const ImageUploader = ({ onImageUploaded }: { onImageUploaded: (imageUrl: string) => void }) => {
  const [uploading, setUploading] = useState(false);
  const [uploadError, setUploadError] = useState<string | null>(null);
  
  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;
    
    const file = files[0];
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (–º–µ–Ω–µ–µ 5 –ú–ë)
    if (file.size > 5 * 1024 * 1024) {
      setUploadError("–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –±–æ–ª–µ–µ 5 –ú–ë");
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ (—Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
    if (!file.type.startsWith('image/')) {
      setUploadError("–†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
      return;
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    setUploading(true);
    setUploadError(null);
    
    try {
      const formData = new FormData();
      formData.append('file', file);
      
      const response = await axios.post(`${API_BASE_URL}/upload-image`, formData, {
        headers: {
          'Content-Type': 'multipart/form-data'
        }
      });
      
      if (response.data && response.data.url) {
        onImageUploaded(response.data.url);
      } else {
        setUploadError("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
      }
    } catch (error: any) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:", error);
      setUploadError(error.response?.data?.detail || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ");
    } finally {
      setUploading(false);
    }
  };
  
  return (
    <div className="image-uploader">
      <label className="upload-button-label">
        <input 
          type="file" 
          accept="image/*" 
          onChange={handleFileChange} 
          disabled={uploading}
          style={{ display: 'none' }}
        />
        <span className="action-button">
          {uploading ? "–ó–∞–≥—Ä—É–∑–∫–∞..." : "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"}
        </span>
      </label>
      {uploadError && <p className="error-message">{uploadError}</p>}
    </div>
  );
};

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–∞–ª–µ—Ä–µ–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ—Å—Ç–∞
const PostImageGallery = ({ 
  postId, 
  onImageSelect 
}: { 
  postId: string; 
  onImageSelect?: (imageUrl: string) => void 
}) => {
  const [images, setImages] = useState<any[]>([]);
  const [loading, setLoading] = useState<boolean>(false);
  const [error, setError] = useState<string | null>(null);
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  const loadImages = useCallback(async () => {
    if (!postId) return;
    
    setLoading(true);
    setError(null);
    
    try {
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø–æ—Å—Ç–∞
      const response = await axios.get(`${API_BASE_URL}/posts/${postId}/images`);
      
      if (response.data && response.data.images) {
        setImages(response.data.images);
      }
    } catch (err: any) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ—Å—Ç–∞:', err);
      setError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
    } finally {
      setLoading(false);
    }
  }, [postId]);
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
  useEffect(() => {
    loadImages();
  }, [loadImages]);
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const handleSelect = (image: any) => {
    if (onImageSelect) {
      onImageSelect(image.url);
    }
  };
  
  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
  if (loading) {
    return (
      <div className="post-image-gallery loading">
        <div className="loading-spinner small"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...</p>
      </div>
    );
  }

  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—à–∏–±–∫—É
  if (error) {
    return (
      <div className="post-image-gallery error">
        <p>{error}</p>
      </div>
    );
  }
  
  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  if (!images || images.length === 0) {
    return (
      <div className="post-image-gallery empty">
        <p>–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p>
      </div>
    );
  }
  
  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≥–∞–ª–µ—Ä–µ—é
  return (
    <div className="post-image-gallery">
      <div className="image-grid">
        {images.map((image, index) => (
          <div 
            key={image.id || index} 
            className="image-item"
            onClick={() => handleSelect(image)}
          >
            <img 
              src={image.preview_url || image.url} 
              alt={image.alt || "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å—Ç–∞"} 
              className="thumbnail"
              onError={(e) => {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const target = e.target as HTMLImageElement;
                target.onerror = null;
                target.src = 'https://via.placeholder.com/100?text=–û—à–∏–±–∫–∞';
              }}
            />
            {image.author && (
              <div className="image-author">
                {image.author}
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
};

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–Ω—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
const CalendarDay = ({ 
  day, 
  onEditPost, 
  onDeletePost 
}: { 
  day: CalendarDay; 
  onEditPost: (post: SavedPost) => void;
  onDeletePost: (postId: string) => void;
}) => {
  const { date, posts, isCurrentMonth, isToday } = day;
  const dayNumber = date.getDate();
  
  // –ö–ª–∞—Å—Å –¥–ª—è —è—á–µ–π–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
  const cellClass = `calendar-day ${isCurrentMonth ? '' : 'other-month'} ${isToday ? 'today' : ''}`;
  
  return (
    <div className={cellClass}>
      <div className="day-number">{dayNumber}</div>
      {posts.length > 0 && (
        <div className="day-posts">
          {posts.map((post) => (
            <div key={post.id} className="post-item">
              <div className="post-title" title={post.topic_idea}>
                {post.topic_idea.length > 25 
                  ? post.topic_idea.substring(0, 22) + '...' 
                  : post.topic_idea
                }
              </div>
              <div className="post-actions">
                <button 
                  className="action-button edit-button" 
                  onClick={() => onEditPost(post)}
                  title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                >
                  <span>üìù</span>
                </button>
                <button 
                  className="action-button delete-button" 
                  onClick={() => onDeletePost(post.id)}
                  title="–£–¥–∞–ª–∏—Ç—å"
                >
                  <span>üóëÔ∏è</span>
                </button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ –≥–∞–ª–µ—Ä–µ–∏
const ImageGallery = ({ onImageSelect }) => {
  const [images, setImages] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [selectedImages, setSelectedImages] = useState([]);

  useEffect(() => {
    fetchUserImages();
  }, []);

  const fetchUserImages = async () => {
    setLoading(true);
    setError('');
    
    try {
      const response = await axios.get(`${API_BASE_URL}/images`, {
        headers: { "x-telegram-user-id": userId || 'unknown' }
      });
      
      setImages(response.data);
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', err);
      setError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
    } finally {
      setLoading(false);
    }
  };

  const handleImageClick = (image) => {
    // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–∂–µ –≤—ã–±—Ä–∞–Ω–æ, —É–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
    if (selectedImages.some(img => img.id === image.id)) {
      setSelectedImages(selectedImages.filter(img => img.id !== image.id));
    } else {
      // –ò–Ω–∞—á–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
      setSelectedImages([...selectedImages, image]);
    }
  };

  const confirmSelection = () => {
    // –ü–µ—Ä–µ–¥–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ callback
    onImageSelect(selectedImages);
  };

  return (
    <div style={{ marginTop: '20px' }}>
      <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
      
      {loading && <div>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...</div>}
      {error && <div style={{ color: 'red' }}>{error}</div>}
      
      {images.length === 0 && !loading && !error && (
        <div>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>
      )}
      
      <div style={{ 
        display: 'grid', 
        gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', 
        gap: '10px', 
        marginTop: '10px' 
      }}>
        {images.map(image => (
          <div 
            key={image.id} 
            style={{ 
              border: selectedImages.some(img => img.id === image.id) 
                ? '3px solid blue' 
                : '1px solid #ddd',
              borderRadius: '4px',
              padding: '5px',
              cursor: 'pointer'
            }}
            onClick={() => handleImageClick(image)}
          >
            <img 
              src={image.url} 
              alt={image.alt_description || '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'} 
              style={{ 
                width: '100%', 
                height: '120px', 
                objectFit: 'cover',
                borderRadius: '2px'
              }} 
            />
          </div>
        ))}
      </div>
      
      {images.length > 0 && (
        <button 
          onClick={confirmSelection}
          style={{
            marginTop: '15px',
            padding: '8px 16px',
            backgroundColor: '#0088cc',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: 'pointer'
          }}
        >
          –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä ({selectedImages.length})
        </button>
      )}
    </div>
  );
};

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
const SelectedImagesPreview = ({ images, onRemove }) => {
  if (!images || images.length === 0) return null;
  
  return (
    <div style={{ marginTop: '15px' }}>
      <h4>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h4>
      <div style={{ 
        display: 'flex', 
        flexWrap: 'wrap', 
        gap: '10px' 
      }}>
        {images.map(image => (
          <div 
            key={image.id} 
            style={{ 
              position: 'relative',
              border: '1px solid #ddd',
              borderRadius: '4px',
              padding: '5px',
              width: '120px'
            }}
          >
            <img 
              src={image.url} 
              alt={image.alt_description || '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'} 
              style={{ 
                width: '100%', 
                height: '100px', 
                objectFit: 'cover',
                borderRadius: '2px'
              }} 
            />
            <button
              onClick={() => onRemove(image)}
              style={{
                position: 'absolute',
                top: '5px',
                right: '5px',
                background: 'rgba(255, 255, 255, 0.7)',
                border: 'none',
                borderRadius: '50%',
                width: '24px',
                height: '24px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                cursor: 'pointer'
              }}
            >
              ‚úï
            </button>
          </div>
        ))}
      </div>
    </div>
  );
};

function App() {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [loading, setLoading] = useState(true);
  const [userId, setUserId] = useState<string | null>(null);
  const [currentView, setCurrentView] = useState<ViewType>('analyze');
  const [channelName, setChannelName] = useState<string>('');
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analysisResult, setAnalysisResult] = useState<AnalysisResult | null>(null);
  const [isGeneratingIdeas, setIsGeneratingIdeas] = useState(false);
  const [suggestedIdeas, setSuggestedIdeas] = useState<SuggestedIdea[]>([]);
  const [selectedIdea, setSelectedIdea] = useState<SuggestedIdea | null>(null);
  const [detailedPost, setDetailedPost] = useState<DetailedPost | null>(null);
  const [isDetailGenerating, setIsDetailGenerating] = useState(false);
  const [error, setError] = useState<string | null>(null); 
  const [success, setSuccess] = useState<string | null>(null);
  // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const [selectedImage, setSelectedImage] = useState<number | null>(null);
  // –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  const [previewVisible, setPreviewVisible] = useState<boolean>(false);
  const [previewUrl, setPreviewUrl] = useState<string>('');
  
  // –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
  const [savedPosts, setSavedPosts] = useState<SavedPost[]>([]);
  const [loadingSavedPosts, setLoadingSavedPosts] = useState(false);
  const [currentMonth, setCurrentMonth] = useState<Date>(new Date());
  const [selectedDate, setSelectedDate] = useState<Date>(new Date());
  const [calendarDays, setCalendarDays] = useState<CalendarDay[]>([]);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç–æ–≤
  const [editingPost, setEditingPost] = useState<SavedPost | null>(null);
  const [editedText, setEditedText] = useState<string>('');
  const [editedImageUrl, setEditedImageUrl] = useState<string>('');
  const [editedDate, setEditedDate] = useState<string>('');
  const [isSavingPost, setIsSavingPost] = useState(false);
  const [selectedChannels, setSelectedChannels] = useState<string[]>([]);
  const [allChannels, setAllChannels] = useState<string[]>([]);

  // –î–æ–±–∞–≤–ª—è–µ–º –∫–µ—à –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
  const [detailsCache, setDetailsCache] = useState<CachedPostDetails>({});

  // –ë—ã—Å—Ç—Ä–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑ localStorage
  useEffect(() => {
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ localStorage
    const storedChannel = localStorage.getItem('channelName');
    if (storedChannel) {
      setChannelName(storedChannel);
    }
    
    const storedSelectedChannels = localStorage.getItem('selectedChannels');
    if (storedSelectedChannels) {
      try {
        setSelectedChannels(JSON.parse(storedSelectedChannels));
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤:', e);
      }
    }
    
    setTimeout(() => {
      setLoading(false);
    }, 500);
  }, []);

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–Ω–∞–ª –≤ localStorage –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
  useEffect(() => {
    if (channelName) {
      localStorage.setItem('channelName', channelName);
      
      // –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–Ω–∞–ª –≤ —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ –∑–¥–µ—Å—å - 
      // —ç—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
    }
  }, [channelName]);
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  useEffect(() => {
    if (isAuthenticated) {
      const storedChannels = localStorage.getItem('allChannels');
      if (storedChannels) {
        try {
          setAllChannels(JSON.parse(storedChannels));
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤:', e);
        }
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã
      fetchSavedPosts();
    }
  }, [isAuthenticated]);
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–Ω–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–µ—Å—è—Ü–∞ –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
  useEffect(() => {
    if (currentMonth) {
      generateCalendarDays();
    }
  }, [currentMonth, savedPosts]);
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–Ω–µ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—è
  const generateCalendarDays = () => {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    
    // –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
    const firstDay = new Date(year, month, 1);
    // –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
    const lastDay = new Date(year, month + 1, 0);
    
    // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è (0 - –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 1 - –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –∏ —Ç.–¥.)
    let firstDayOfWeek = firstDay.getDay();
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–ª—è –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏ —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞ (0 - –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 6 - –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)
    firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
    
    // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–Ω–µ–π –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    const days: CalendarDay[] = [];
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    for (let i = firstDayOfWeek - 1; i >= 0; i--) {
      const date = new Date(year, month - 1, prevMonthLastDay - i);
      days.push({
        date,
        posts: savedPosts.filter(post => new Date(post.target_date).toDateString() === date.toDateString()),
        isCurrentMonth: false,
        isToday: date.toDateString() === new Date().toDateString()
      });
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
    for (let i = 1; i <= lastDay.getDate(); i++) {
      const date = new Date(year, month, i);
      days.push({
        date,
        posts: savedPosts.filter(post => new Date(post.target_date).toDateString() === date.toDateString()),
        isCurrentMonth: true,
        isToday: date.toDateString() === new Date().toDateString()
      });
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞
    const daysToAdd = 42 - days.length; // 6 —Å—Ç—Ä–æ–∫ –ø–æ 7 –¥–Ω–µ–π
    for (let i = 1; i <= daysToAdd; i++) {
      const date = new Date(year, month + 1, i);
      days.push({
        date,
        posts: savedPosts.filter(post => new Date(post.target_date).toDateString() === date.toDateString()),
        isCurrentMonth: false,
        isToday: date.toDateString() === new Date().toDateString()
      });
    }
    
    setCalendarDays(days);
  };
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü
  const goToPrevMonth = () => {
    setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1));
  };
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü
  const goToNextMonth = () => {
    setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1));
  };
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
  const fetchSavedPosts = async () => {
    setLoadingSavedPosts(true);
    setError(null);
    
    try {
      // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –Ω–µ—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ø–æ—Å—Ç—ã
      if (selectedChannels.length === 0) {
        const response = await axios.get('/posts');
        
        if (response.data && Array.isArray(response.data)) {
          setSavedPosts(response.data);
          
          // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –∏–∑ –ø–æ—Å—Ç–æ–≤
          updateChannelsFromPosts(response.data);
      }
    } else {
        // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–ª—å—Ç—Ä
        const allPosts: SavedPost[] = [];
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
        for (const channel of selectedChannels) {
          try {
            const response = await axios.get('/posts', {
              params: { channel_name: channel }
            });
            
            if (response.data && Array.isArray(response.data)) {
              allPosts.push(...response.data);
            }
          } catch (err) {
            console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ—Å—Ç–æ–≤ –¥–ª—è –∫–∞–Ω–∞–ª–∞ ${channel}:`, err);
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –¥—Ä—É–≥–∏–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏
          }
        }
        
        setSavedPosts(allPosts);
      }
    } catch (err: any) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤:', err);
      setError(err.response?.data?.detail || err.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤');
    } finally {
      setLoadingSavedPosts(false);
    }
  };
  
  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤ –∏–∑ –ø–æ—Å—Ç–æ–≤
  const updateChannelsFromPosts = (posts: SavedPost[]) => {
    // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –∏–∑ –ø–æ—Å—Ç–æ–≤
    const channels = [...new Set(posts
      .map(post => post.channel_name)
      .filter((channel): channel is string => !!channel) // –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º undefined –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Ç–∏–ø—É string
    )];
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤
    if (channels.length > 0) {
      const updatedChannels = [...new Set([...allChannels, ...channels])];
      setAllChannels(updatedChannels);
      localStorage.setItem('allChannels', JSON.stringify(updatedChannels));
    }
  };
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  const regeneratePostDetails = async () => {
    if (!selectedIdea) return;
    
    setIsDetailGenerating(true);
    setError('');
    setSuccess('');

    try {
      const response = await axios.post(`${API_BASE_URL}/generate-post-details`, {
        topic_idea: selectedIdea.topic_idea,
        format_style: selectedIdea.format_style || '',
        channel_name: selectedIdea.channel_name || '',
        regenerate_images_only: true
      }, {
        headers: {
          'x-telegram-user-id': userId || 'unknown'
        }
      });

      if (response.data && response.data.found_images && detailedPost) {
        const newImages = response.data.found_images.map((img: any) => ({
          url: img.url || img.urls?.regular || img.regular_url || img.preview_url || '',
          alt: img.alt_description || img.description || '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ—Å—Ç–∞',
          author: img.user?.name || img.author_name || '',
          author_url: img.user?.links?.html || img.author_url || ''
        }));

        setDetailedPost(prevState => {
          if (!prevState) return null;
          return {
            ...prevState,
            images: newImages
          };
        });

        if (selectedIdea && detailedPost) {
          setDetailsCache(prev => {
            const updatedCache = prev || {};
            return {
              ...updatedCache,
              [selectedIdea.id]: {
                ...detailedPost,
                images: newImages
              }
            };
          });
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        setSelectedImage(null);
        setSuccess('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
      }
    } catch (err: any) {
      setError(err.response?.data?.detail || err.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π');
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', err);
    } finally {
      setIsDetailGenerating(false);
    }
  };

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
  const handleSavePost = async () => {
    if (!selectedIdea || !detailedPost) {
      setError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–¥–µ—é –∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ—Å—Ç –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º");
      return;
    }

    setIsSavingPost(true);
    setError("");
    setSuccess("");

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–æ—Å—Ç–∞
    const savedImageIds: string[] = [];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ—Å—Ç–µ
    if (detailedPost.images && detailedPost.images.length > 0) {
      for (const img of detailedPost.images) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–µ—Ç url –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
        if (img && img.url) {
          try {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            const imageId = `img_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            const response = await axios.post(`${API_BASE_URL}/save-image`, {
              id: imageId,
              url: img.url,
              alt_description: img.alt || "",
              source: "unsplash"
            }, {
              headers: { "x-telegram-user-id": userId || 'unknown' }
            });
            
            savedImageIds.push(imageId);
            console.log("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ:", response.data);
          } catch (error) {
            // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å - –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:", error);
            setError(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${error instanceof Error ? error.message : String(error)}`);
          }
        } else {
          console.warn("–ü—Ä–æ–ø—É—â–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–µ–∑ URL:", img);
        }
      }
    }

    try {
      const postData = {
        topic_idea: selectedIdea?.topic_idea || "",
        format_style: selectedIdea?.format_style || "",
        post_text: detailedPost.post_text,
        channel_name: selectedIdea?.channel_name || "",
        target_date: selectedDate,
        images: savedImageIds
      };

      console.log("–°–æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞:", postData);
      
      const response = await axios.post(`${API_BASE_URL}/posts`, postData, {
        headers: { "x-telegram-user-id": userId || 'unknown' }
      });

      console.log("–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω:", response.data);
      setSuccess("–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
      fetchSavedPosts();
      
      // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      setSelectedIdea(null);
      setDetailedPost(null);
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞:", error);
      setError(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞: ${error instanceof Error ? error.message : String(error)}`);
    } finally {
      setIsSavingPost(false);
    }
  };
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞
  const updatePost = async () => {
    if (!editingPost) return;
    
    setIsSavingPost(true);
    setError(null);
    
    try {
      const postData = {
        ...editingPost,
        final_text: editedText,
        image_url: editedImageUrl,
        target_date: editedDate
      };
      
      const response = await axios.put(`/posts/${editingPost.id}`, postData);
      
      if (response.data) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å—Ç –≤ —Å–ø–∏—Å–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö
        setSavedPosts(savedPosts.map(post => 
          post.id === editingPost.id ? response.data : post
        ));
        setSuccess('–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
        setCurrentView('calendar');
        setEditingPost(null);
      }
    } catch (err: any) { 
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞:', err);
      setError(err.response?.data?.detail || err.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞');
    } finally {
      setIsSavingPost(false);
    }
  };
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞
  const deletePost = async (postId: string) => {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) return;
    
    try {
      await axios.delete(`/posts/${postId}`);
      
      // –£–¥–∞–ª—è–µ–º –ø–æ—Å—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö
      setSavedPosts(savedPosts.filter(post => post.id !== postId));
      setSuccess('–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
    } catch (err: any) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞:', err);
      setError(err.response?.data?.detail || err.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞');
    }
  };
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç–∞
  const startEditingPost = (post: SavedPost) => {
    setEditingPost(post);
    setEditedText(post.final_text);
    setEditedImageUrl(post.image_url || '');
    setEditedDate(post.target_date);
    setCurrentView('edit');
  };
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–¥–µ–π –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
  const saveIdeasToDatabase = async () => {
    if (suggestedIdeas.length === 0) return;
    
    setIsGeneratingIdeas(true);
    setError(null);
    
    try {
      const response = await axios.post('/save-ideas', {
        ideas: suggestedIdeas,
          channel_name: channelName 
      });
      
      if (response.data && response.data.message) {
        setSuccess(response.data.message);
      }
    } catch (err: any) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–¥–µ–π:', err);
      setError(err.response?.data?.detail || err.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–¥–µ–π');
    } finally {
      setIsGeneratingIdeas(false);
    }
  };
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–æ–≤ –ø–æ –∫–∞–Ω–∞–ª–∞–º
  const filterPostsByChannels = async () => {
    if (selectedChannels.length === 0) {
      setError("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–∞–Ω–∞–ª –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏");
      return;
    }
    
    // –ü—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤
    await fetchSavedPosts();
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const handleAuthSuccess = (authUserId: string) => {
    console.log('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞:', authUserId);
    setUserId(authUserId);
    setIsAuthenticated(true);
    axios.defaults.headers.common['X-Telegram-User-Id'] = authUserId;
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–Ω–∞–ª–∞
  const analyzeChannel = async () => {
    if (!channelName) {
      setError("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–∞–Ω–∞–ª–∞");
      return;
    }

    setIsAnalyzing(true);
    setError(null);
    setSuccess(null);
    setAnalysisResult(null);

    try {
      const response = await axios.post('/analyze', { username: channelName });
      setAnalysisResult(response.data);
      setSuccess('–ê–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω');
      
      // –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–Ω–∞–ª –≤ —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤
      if (!allChannels.includes(channelName)) {
        const updatedChannels = [...allChannels, channelName];
        setAllChannels(updatedChannels);
        localStorage.setItem('allChannels', JSON.stringify(updatedChannels));
      
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–Ω–∞–ª –≤ —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç
        if (!selectedChannels.includes(channelName)) {
          const updatedSelected = [...selectedChannels, channelName];
          setSelectedChannels(updatedSelected);
          localStorage.setItem('selectedChannels', JSON.stringify(updatedSelected));
        }
      }
    } catch (err: any) { 
      setError(err.response?.data?.detail || err.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∫–∞–Ω–∞–ª–∞');
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ:', err);
    } finally {
      setIsAnalyzing(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–π
  const generateIdeas = async () => {
    try {
      // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∏–¥–µ–∏, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
      if (suggestedIdeas.length > 0) {
        const confirmed = confirm("–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–¥–µ–∏. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ? –°—Ç–∞—Ä—ã–µ –∏–¥–µ–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.");
        if (!confirmed) {
          return;
        }
      }
      
      setIsGeneratingIdeas(true);
      setError("");
      setSuggestedIdeas([]);

      // –ï—Å–ª–∏ –∞–Ω–∞–ª–∏–∑ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω
      if (!analysisResult) {
        setError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ–¥–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –∫–∞–Ω–∞–ª–∞");
        setIsGeneratingIdeas(false);
      return;
    }

      // –ó–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–¥–µ–π
      const response = await axios.post(
        `${API_BASE_URL}/generate-plan`,
        {
          themes: analysisResult.themes,
          styles: analysisResult.styles,
          period_days: 7,
          channel_name: channelName
        },
        {
          headers: {
            'x-telegram-user-id': userId || 'unknown'
          }
        }
      );

      if (response.data && response.data.plan) {
        console.log('–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –∏–¥–µ–∏:', response.data.plan);
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∏–¥–µ–∏ –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        const formattedIdeas = response.data.plan.map((idea: any, index: number) => ({
          id: `idea-${Date.now()}-${index}`,
          topic_idea: idea.topic_idea || idea.title,
          format_style: idea.format_style || idea.format,
          day: idea.day,
          channel_name: channelName,
          isNew: true,
        }));

        setSuggestedIdeas(formattedIdeas);
        setSuccess('–ò–¥–µ–∏ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–¥–µ–∏
        saveIdeasToDatabase();
      }
    } catch (err: any) { 
      setError(err.response?.data?.detail || err.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–π');
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–π:', err);
    } finally {
      setIsGeneratingIdeas(false);
      setCurrentView('suggestions');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–¥–µ–π
  const fetchSavedIdeas = async () => {
    if (!channelName) return;
    
    setIsGeneratingIdeas(true);
    setError(null);
    
    try {
      const response = await axios.get('/ideas', {
        params: { channel_name: channelName }
      });
      if (response.data && Array.isArray(response.data.ideas)) {
        setSuggestedIdeas(response.data.ideas);
      }
    } catch (err: any) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–¥–µ–π:', err);
    } finally {
      setIsGeneratingIdeas(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π –∏–¥–µ–∏
  const handleDetailIdea = async (idea: SuggestedIdea) => {
    try {
      setSelectedIdea(idea);
      setIsDetailGenerating(true);
      setDetailedPost(null);
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏ –Ω–æ–≤–æ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
      setSelectedImage(null);
      setError("");

      // –ó–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–µ—Ç–∞–ª–µ–π –ø–æ—Å—Ç–∞
      const response = await axios.post(
        `${API_BASE_URL}/generate-post-details`,
        {
          topic_idea: idea.topic_idea,
          format_style: idea.format_style,
          channel_name: idea.channel_name
        },
        {
          headers: {
            'x-telegram-user-id': userId || 'unknown'
          }
        }
      );

      // –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ
      if (response.data) {
        const newDetails = {
          post_text: response.data.generated_text || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞.',
          images: response.data.found_images ? response.data.found_images.map((img: any) => ({
            url: img.regular_url || img.preview_url,
            alt: img.description,
            author: img.author_name,
            author_url: img.author_url
          })) : []
        };
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if (newDetails.images.length > 0) {
          setSelectedImage(0);
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à –∏ –≤ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        setDetailedPost(newDetails);
        setDetailsCache(prev => ({
          ...prev,
          [idea.id]: newDetails
        }));
        
        setSuccess('–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞');
      }
    } catch (err: any) {
      setError(err.response?.data?.detail || err.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–¥–µ–∏');
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏:', err);
    } finally {
      setCurrentView('details');
      setIsDetailGenerating(false);
    }
  };

  // –í–æ–∑–≤—Ä–∞—Ç –∫ —Å–ø–∏—Å–∫—É –∏–¥–µ–π
  const backToIdeas = () => {
    setCurrentView('suggestions');
    setSelectedIdea(null);
    setDetailedPost(null);
  };

  // –î–æ–±–∞–≤–∏–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const handlePreviewImage = (imageUrl: string) => {
    setPreviewUrl(imageUrl);
    setPreviewVisible(true);
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
  const handleClosePreview = () => {
    setPreviewVisible(false);
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const handleSelectImage = (index: number) => {
    setSelectedImage(index === selectedImage ? null : index);
  };

  // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏
  if (loading) {
    return (
      <div className="loading-container">
        <div className="loading-spinner"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</p>
    </div>
  );
  }

  // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  if (!isAuthenticated) {
    return <TelegramAuth onAuthSuccess={handleAuthSuccess} />;
  }

  // –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  return (
    <div className="app-container">
      <header className="app-header">
        <h1>Smart Content Assistant</h1>
      </header>

      <main className="app-main">
        {/* –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ —É—Å–ø–µ—à–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ */}
        {error && <div className="error-message">{error}</div>}
        {success && <div className="success-message">{success}</div>}

        {/* –ù–∞–≤–∏–≥–∞—Ü–∏—è */}
    <div className="navigation-buttons">
          <button 
            onClick={() => setCurrentView('analyze')} 
            className={`action-button ${currentView === 'analyze' ? 'active' : ''}`}
          >
            –ê–Ω–∞–ª–∏–∑
          </button>
          <button 
            onClick={() => {
              setCurrentView('suggestions');
              if (suggestedIdeas.length === 0) {
                fetchSavedIdeas();
              }
            }} 
            className={`action-button ${currentView === 'suggestions' ? 'active' : ''}`}
            disabled={!channelName}
          >
            –ò–¥–µ–∏
          </button>
          <button 
            onClick={() => {
              setCurrentView('plan');
              fetchSavedPosts();
            }} 
            className={`action-button ${currentView === 'plan' ? 'active' : ''}`}
          >
            –ü–ª–∞–Ω
          </button>
          <button 
            onClick={() => {
              setCurrentView('calendar');
              fetchSavedPosts();
            }} 
            className={`action-button ${currentView === 'calendar' ? 'active' : ''}`}
          >
            –ö–∞–ª–µ–Ω–¥–∞—Ä—å
          </button>
    </div>

        {/* –í—ã–±–æ—Ä –∫–∞–Ω–∞–ª–∞ */}
        <div className="channel-selector">
          <label>–ö–∞–Ω–∞–ª—ã: </label>
          <select 
            value={channelName} 
            onChange={(e) => setChannelName(e.target.value)}
            className="channel-select"
          >
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª</option>
            {allChannels.map(channel => (
              <option key={channel} value={channel}>{channel}</option>
            ))}
          </select>
        </div>

        {/* –ö–æ–Ω—Ç–µ–Ω—Ç */}
        <div className="view-container">
          {/* –í–∏–¥ –∞–Ω–∞–ª–∏–∑–∞ */}
          {currentView === 'analyze' && (
            <div className="view analyze-view">
      <h2>–ê–Ω–∞–ª–∏–∑ Telegram-–∫–∞–Ω–∞–ª–∞</h2>
      <div className="input-container">
        <input
          type="text"
          className="channel-input"
          value={channelName}
          onChange={(e) => setChannelName(e.target.value.replace(/^@/, ''))}
          placeholder="–í–≤–µ–¥–∏—Ç–µ username –∫–∞–Ω–∞–ª–∞ (–±–µ–∑ @)"
                  disabled={isAnalyzing}
                />
                <button 
                  onClick={analyzeChannel} 
                  className="action-button"
                  disabled={isAnalyzing || !channelName}
                >
                  {isAnalyzing ? '–ê–Ω–∞–ª–∏–∑...' : '–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å'}
        </button>
      </div>

              {isAnalyzing && (
                <div className="loading-indicator">
                  <div className="loading-spinner"></div>
                  <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–Ω–∞–ª...</p>
                </div>
              )}

      {analysisResult && (
          <div className="results-container">
              <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:</h3>
              <p><strong>–¢–µ–º—ã:</strong> {analysisResult.themes.join(', ')}</p>
              <p><strong>–°—Ç–∏–ª–∏:</strong> {analysisResult.styles.join(', ')}</p>
                  <p><strong>–õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–æ—Å—Ç–∏–Ω–≥–∞:</strong> {analysisResult.best_posting_time}</p>
                  <p><strong>–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –ø–æ—Å—Ç–æ–≤:</strong> {analysisResult.analyzed_posts_count}</p>
                  
              <button 
                    onClick={generateIdeas} 
                    className="action-button generate-button"
                    disabled={isGeneratingIdeas}
                  >
                    {isGeneratingIdeas ? '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...' : '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–¥–µ–∏'}
              </button>
          </div>
      )}

              {!analysisResult && !isAnalyzing && (
                <p>–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–∞–Ω–∞–ª–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∞. –ù–∞–ø—Ä–∏–º–µ—Ä: durov</p>
      )}
    </div>
          )}

          {/* –í–∏–¥ –∏–¥–µ–π */}
          {currentView === 'suggestions' && (
            <div className="view suggestions-view">
              <h2>–ò–¥–µ–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h2>
              
              {isGeneratingIdeas && (
                <div className="loading-indicator">
                  <div className="loading-spinner"></div>
                  <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–¥–µ–π...</p>
              </div>
              )}

              {suggestedIdeas.length > 0 ? (
                <div className="ideas-list">
                  {suggestedIdeas.map((idea) => (
                    <div key={idea.id} className="idea-item">
                      <div className="idea-content">
                        <div className="idea-header">
                          <span className="idea-title">{idea.topic_idea}</span>
                          <span className="idea-style">({idea.format_style})</span>
            </div>
                        {idea.day && <div className="idea-day">–î–µ–Ω—å {idea.day}</div>}
                                </div>
                            <button 
                        className="action-button small"
                        onClick={() => handleDetailIdea(idea)}
                      >
                        –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                  ))}
                    </div>
              ) : !isGeneratingIdeas ? (
                <p>
                  {analysisResult 
                    ? '–ù–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–¥–µ–∏" –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –ê–Ω–∞–ª–∏–∑, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ –∏–¥–µ–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞.' 
                    : '–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –∫–∞–Ω–∞–ª–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ê–Ω–∞–ª–∏–∑".'
                  }
                </p>
              ) : null}
                </div>
            )}

          {/* –í–∏–¥ –ø–ª–∞–Ω–∞ */}
          {currentView === 'plan' && (
            <div className="view plan-view">
              <h2>–ü–ª–∞–Ω –ø—É–±–ª–∏–∫–∞—Ü–∏–π</h2>
              
              {loadingSavedPosts ? (
                <div className="loading-indicator">
                  <div className="loading-spinner"></div>
                  <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤...</p>
                                </div>
              ) : savedPosts.length > 0 ? (
                <div className="plan-display">
                  <h3>–ü–ª–∞–Ω –ø—É–±–ª–∏–∫–∞—Ü–∏–π –¥–ª—è –∫–∞–Ω–∞–ª–∞ {channelName ? `@${channelName}` : ""}</h3>
                  <ul className="plan-list">
                    {savedPosts
                      .sort((a, b) => new Date(a.target_date).getTime() - new Date(b.target_date).getTime())
                      .map((post) => (
                        <li key={post.id} className="plan-list-item-clickable" onClick={() => startEditingPost(post)}>
                          <strong>{new Date(post.target_date).toLocaleDateString()}:</strong> {post.topic_idea} 
                          <em>({post.format_style})</em>
                          {post.channel_name && <span className="post-channel">@{post.channel_name}</span>}
                            </li>
                        ))}
                    </ul>
            </div>
              ) : (
                <div className="empty-plan">
                  <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–æ—Å—Ç—ã –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ò–¥–µ–∏", –∑–∞—Ç–µ–º –¥–µ—Ç–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏—Ö.</p>
        <button 
                    className="action-button" 
          onClick={() => {
                      setCurrentView('suggestions');
                      if (suggestedIdeas.length === 0) {
                        fetchSavedIdeas();
                      }
                    }}
                  >
                    –ü–µ—Ä–µ–π—Ç–∏ –∫ –∏–¥–µ—è–º
        </button>
             </div>
              )}
               </div>
          )}

          {/* –í–∏–¥ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ */}
          {currentView === 'details' && (
            <div className="details-view">
              {selectedIdea ? (
                <>
                  <h2>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç-–∏–¥–µ–∏</h2>
                  <div className="idea-details">
                    <p><strong>–¢–µ–º–∞:</strong> {selectedIdea.topic_idea}</p>
                    <p><strong>–§–æ—Ä–º–∞—Ç:</strong> {selectedIdea.format_style}</p>
                    <p><strong>–ö–∞–Ω–∞–ª:</strong> {selectedIdea.channel_name}</p>
                  </div>
                  
                  {isDetailGenerating ? (
                    <Loading message="–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ –ø–æ—Å—Ç–∞..." />
                  ) : error ? (
                    <ErrorMessage message={error} onClose={() => setError(null)} />
                  ) : success ? (
                    <SuccessMessage message={success} onClose={() => setSuccess(null)} />
                  ) : detailedPost ? (
                    <div className="post-details">
                      <div className="text-section">
                        <h3>–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞:</h3>
              <textarea
                          value={detailedPost.post_text}
                          onChange={(e) => 
                            setDetailedPost({
                              ...detailedPost,
                              post_text: e.target.value
                            })
                          }
                rows={10}
                          className="post-text-editor"
              />
            </div>
                      
                      {detailedPost.images && detailedPost.images.length > 0 && (
                        <div className="image-section">
                          <h3>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</h3>
                <div className="image-thumbnails">
                            {detailedPost.images.map((img, index) => (
                              <div key={index} className={`image-item ${selectedImage === index ? 'selected' : ''}`}>
                                <img 
                                  src={img.url} 
                                  alt={img.alt || "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ—Å—Ç–∞"} 
                                  className="thumbnail"
                                  onClick={() => setSelectedImage(index)}
                                  onError={(e) => {
                                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                    const target = e.target as HTMLImageElement;
                                    target.onerror = null; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Ü–∏–∫–ª–∏—á–µ—Å–∫—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
                                    target.src = 'https://via.placeholder.com/150?text=–û—à–∏–±–∫–∞+–∑–∞–≥—Ä—É–∑–∫–∏';
                                  }}
                                />
                                <div className="image-overlay">
                                  <button 
                                    className="select-image-button"
                                    onClick={() => setSelectedImage(index)}
                                  >
                                    {selectedImage === index ? '‚úì –í—ã–±—Ä–∞–Ω–æ' : '–í—ã–±—Ä–∞—Ç—å'}
                                  </button>
                                </div>
                    </div>
                  ))}
                </div>
                    <div className="selected-image-preview">
                            {selectedImage !== null && detailedPost.images[selectedImage] && (
                              <div className="preview-container">
                                <h4>–í—ã–±—Ä–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</h4>
                      <img 
                                  src={detailedPost.images[selectedImage].url} 
                                  alt={detailedPost.images[selectedImage].alt || "–í—ã–±—Ä–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"} 
                        className="preview-image" 
                                  onError={(e) => {
                                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø—Ä–µ–≤—å—é
                                    const target = e.target as HTMLImageElement;
                                    target.onerror = null;
                                    target.src = 'https://via.placeholder.com/300?text=–û—à–∏–±–∫–∞+–∑–∞–≥—Ä—É–∑–∫–∏';
                                  }}
                                />
                                {detailedPost.images[selectedImage].author && (
                                  <p className="image-credit">
                                    –ê–≤—Ç–æ—Ä: <a href={detailedPost.images[selectedImage].author_url} target="_blank" rel="noopener noreferrer">
                                      {detailedPost.images[selectedImage].author}
                                    </a>
                                  </p>
                                )}
              </div>
            )}
                  </div>
                  <div className="image-actions">
                            <button 
                              onClick={regeneratePostDetails}
                              className="action-button"
                              disabled={isDetailGenerating}
                            >
                              –û–±–Ω–æ–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    </button>
                            <div className="custom-image-upload">
                              <h4>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</h4>
                              <ImageUploader 
                                onImageUploaded={(url) => {
                                  // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
                                  const newImage = {
                                    url: url,
                                    alt: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
                                  };
                                  
                                  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ detailedPost –∏ –µ—Å—Ç—å –ª–∏ —É –Ω–µ–≥–æ –º–∞—Å—Å–∏–≤ images
                                  if (detailedPost) {
                                    const updatedImages = detailedPost.images ? [newImage, ...detailedPost.images] : [newImage];
                                    const updatedPost: DetailedPost = {
                                      ...detailedPost,
                                      images: updatedImages
                                    };
                                    
                                    setDetailedPost(updatedPost);
                                    
                                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
                                    setSelectedImage(0);
                                    
                                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à
                                    if (selectedIdea) {
                                      setDetailsCache(prev => {
                                        if (prev === null) return { [selectedIdea.id]: updatedPost };
                                        return {
                                          ...prev,
                                          [selectedIdea.id]: updatedPost
                                        };
                                      });
                                    }
                                  }
                                }} 
                              />
                  </div>
                </div>
              </div>
            )}

                      {/* –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å—Ç–∞ */}
                      <div className="actions-section">
                        <h3>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å—Ç:</h3>
                        <div className="date-picker-container">
                          <label>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: </label>
                    <input 
                            type="date" 
                            value={selectedDate.toISOString().split('T')[0]}
                            onChange={(e) => setSelectedDate(new Date(e.target.value))}
                            className="date-input"
                          />
                        </div>
                    <button 
                          onClick={handleSavePost}
                          className="action-button save-button"
                          disabled={isSavingPost}
                        >
                          {isSavingPost ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å—Ç'}
                    </button>
                      </div>
                    </div>
                  ) : null}
                </>
              ) : (
                <div className="empty-details">
                  <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏–¥–µ—é –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏</p>
               </div>
            )}
          </div>
          )}
          
          {/* –í–∏–¥ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */}
          {currentView === 'calendar' && (
            <div className="view calendar-view">
              <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—É–±–ª–∏–∫–∞—Ü–∏–π</h2>
              
              {/* –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞–Ω–∞–ª–∞–º */}
              <div className="channels-filter">
                <h3>–§–∏–ª—å—Ç—Ä –ø–æ –∫–∞–Ω–∞–ª–∞–º:</h3>
                
                {/* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞ –≤ —Ñ–∏–ª—å—Ç—Ä */}
                <div className="channels-actions">
                <button 
                    className="action-button"
                    onClick={() => {
                      // –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫–∞–Ω–∞–ª –≤ —Ñ–∏–ª—å—Ç—Ä, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
                      if (channelName && !selectedChannels.includes(channelName)) {
                        const updatedSelected = [...selectedChannels, channelName];
                        setSelectedChannels(updatedSelected);
                        localStorage.setItem('selectedChannels', JSON.stringify(updatedSelected));
                      }
                    }}
                  >
                    + –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫–∞–Ω–∞–ª
                </button>
                  
                  <button
                    className="action-button"
                    onClick={filterPostsByChannels}
                  >
                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä
                </button>
          </div>
                
                {/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ */}
                <div className="selected-channels">
                  {selectedChannels.map((channel) => (
                    <div key={channel} className="selected-channel">
                      <span className="channel-name">@{channel}</span>
                      <button 
                        className="remove-channel"
                        onClick={() => {
                          const updatedSelected = selectedChannels.filter(c => c !== channel);
                          setSelectedChannels(updatedSelected);
                          localStorage.setItem('selectedChannels', JSON.stringify(updatedSelected));
                        }}
                      >
                        ‚úï
                      </button>
      </div>
                  ))}
      </div>
              </div>
              
              {/* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */}
              <div className="calendar-container">
                {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –º–µ—Å—è—Ü–∞ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π */}
                <div className="calendar-header">
                  <button 
                    className="nav-button"
                    onClick={() => {
                      const newDate = new Date(currentMonth);
                      newDate.setMonth(newDate.getMonth() - 1);
                      setCurrentMonth(newDate);
                    }}
                  >
                    &lt;
                  </button>
                  
                  <h3>{currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' })}</h3>
                  
                  <button 
                    className="nav-button"
                    onClick={() => {
                      const newDate = new Date(currentMonth);
                      newDate.setMonth(newDate.getMonth() + 1);
                      setCurrentMonth(newDate);
                    }}
                  >
                    &gt;
                  </button>
                </div>
                
                {/* –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ */}
                <div className="weekdays">
                  {['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'].map((day) => (
                    <div key={day} className="weekday">{day}</div>
                  ))}
                </div>
                
                {/* –î–Ω–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */}
                <div className="calendar-grid">
                  {calendarDays.map((day, index) => (
                    <CalendarDay 
                      key={index} 
                      day={day} 
                      onEditPost={startEditingPost}
                      onDeletePost={(postId) => {
                        if (window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) {
                          deletePost(postId);
                        }
                      }}
                    />
                  ))}
                </div>
              </div>
            </div>
          )}
          
          {/* –í–∏–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç–∞ */}
          {currentView === 'edit' && editingPost && (
            <div className="view edit-view">
              <button onClick={() => {
                setCurrentView('calendar');
                setEditingPost(null);
              }} className="back-button">
                ‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é
              </button>
              
              <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞</h2>
              
              <div className="post-source-info">
                <p><strong>–¢–µ–º–∞:</strong> {editingPost.topic_idea}</p>
                <p><strong>–§–æ—Ä–º–∞—Ç:</strong> {editingPost.format_style}</p>
                <div className="date-picker-container">
                  <label><strong>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</strong></label>
                  <input 
                    type="date" 
                    value={editedDate}
                    onChange={(e) => setEditedDate(e.target.value)}
                    className="date-input"
                  />
                </div>
                {editingPost.channel_name && (
                  <p><strong>–ö–∞–Ω–∞–ª:</strong> @{editingPost.channel_name}</p>
                )}
              </div>
              
              <div className="edit-form">
                <div className="edit-text-section">
                  <h3>–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞:</h3>
                  <textarea 
                    className="edit-textarea" 
                    value={editedText} 
                    onChange={(e) => setEditedText(e.target.value)}
                  />
                </div>
                
                <div className="edit-image-section">
                  <h3>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å—Ç–∞:</h3>
                  {editedImageUrl && (
                    <div className="current-image">
                      <div className="image-preview">
                        <img 
                          src={editedImageUrl} 
                          alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
                          className="preview-image"
                          onError={(e) => {
                            (e.target as HTMLImageElement).src = 'https://via.placeholder.com/300x200?text=–û—à–∏–±–∫–∞+–∑–∞–≥—Ä—É–∑–∫–∏';
                          }}
                        />
                        <button 
                          className="action-button small delete" 
                          onClick={() => setEditedImageUrl('')}
                        >
                          –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        </button>
                      </div>
                    </div>
                  )}
                  
                  <div className="image-selection">
                    <h4>–í—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏:</h4>
                    <PostImageGallery 
                      postId={editingPost.id}
                      onImageSelect={(imageUrl) => setEditedImageUrl(imageUrl)}
                    />
                    
                    <h4>–∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</h4>
                    <ImageUploader onImageUploaded={(url) => setEditedImageUrl(url)} />
                    
                    <h4>–∏–ª–∏ –≤–≤–µ—Å—Ç–∏ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</h4>
                    <div className="image-url-input-container">
                      <input 
                        type="text"
                        className="image-url-input"
                        value={editedImageUrl}
                        onChange={(e) => setEditedImageUrl(e.target.value)}
                        placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
                      />
                    </div>
                  </div>
                </div>
                
                <div className="edit-actions">
                  <button 
                    onClick={updatePost}
                    className="action-button save-button"
                    disabled={isSavingPost}
                  >
                    {isSavingPost ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è'}
                  </button>
                  <button 
                    onClick={() => {
                      setCurrentView('calendar');
                      setEditingPost(null);
                    }}
                    className="action-button cancel-button"
                    disabled={isSavingPost}
                  >
                    –û—Ç–º–µ–Ω–∞
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      </main>

      <footer className="app-footer">
        <p>Telegram User ID: {userId}</p>
      </footer>
    </div>
  );
}

export default App;
