# Настройка проверки подписки на Telegram-канал

Данный функционал проверяет, подписан ли пользователь на указанный Telegram-канал перед доступом к мини-приложению. Если пользователь не подписан, приложение будет закрыто и в чат бота отправится сообщение с инструкцией по подписке.

## Как это работает

1. Когда пользователь открывает мини-приложение, выполняется запрос к `/api/check-app-access`
2. Этот эндпоинт проверяет подписку пользователя на канал через Telegram Bot API
3. Если пользователь не подписан:
   - Приложение закрывается
   - В чат бота отправляется сообщение с кнопкой для перехода на канал
   - После подписки пользователь может нажать кнопку "Проверить подписку" для повторной проверки
4. Если пользователь подписан, приложение продолжает работу в обычном режиме

## Что было реализовано

1. Файл `services/telegram_channel_service.py` с функциями:
   - `send_telegram_message`: отправка сообщений через Telegram Bot API
   - `check_channel_subscription`: проверка статуса подписки пользователя
   - `handle_subscription_check_request`: обработка результата проверки и отправка уведомления

2. В файл `main.py` добавлены:
   - Импорт функций из модуля `telegram_channel_service`
   - Эндпоинт `/api/check-app-access` для проверки доступа при запуске Mini App
   - Обработка callback-запросов от кнопки "Проверить подписку" в функции `telegram_webhook`

## Настройка в Render.com

Для корректной работы необходимо добавить переменную окружения в настройках сервиса на Render.com:

1. Зайдите в панель управления Render.com и выберите ваш сервис
2. Перейдите в раздел "Environment"
3. Добавьте новую переменную:
   - **Ключ**: `TARGET_CHANNEL_USERNAME`
   - **Значение**: имя канала Telegram без символа `@` (например: `my_channel`)
4. Нажмите "Save Changes"
5. Дождитесь перезапуска сервиса или перезапустите его вручную

## Интеграция во фронтенд-приложение

Для проверки подписки фронтенд-часть приложения должна отправлять запрос на эндпоинт `/api/check-app-access` при инициализации:

```javascript
// Пример кода для клиентской части
async function checkChannelSubscription() {
  try {
    const response = await fetch('/api/check-app-access', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Telegram-User-Id': telegramUserId,
        'X-Telegram-Chat-Id': telegramChatId
      }
    });
    
    const result = await response.json();
    
    if (!result.access_granted) {
      // Если доступ не разрешен, закрываем мини-приложение
      Telegram.WebApp.close();
    }
  } catch (error) {
    console.error('Ошибка при проверке подписки:', error);
  }
}

// Вызываем функцию при загрузке приложения
document.addEventListener('DOMContentLoaded', checkChannelSubscription);
```

## Проверка работоспособности

1. Убедитесь, что переменная `TARGET_CHANNEL_USERNAME` настроена на Render.com
2. Запустите мини-приложение как неподписанный пользователь
3. Приложение должно закрыться, и в чат бота должно прийти сообщение с предложением подписаться на канал
4. Подпишитесь на канал
5. Нажмите кнопку "Проверить подписку"
6. После успешной проверки запустите приложение снова - теперь оно должно открыться 