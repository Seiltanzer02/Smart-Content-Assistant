# Решение проблемы с отображением статуса подписки

## Описание проблемы

В интерфейсе ContentHelperBot у пользователей с активной подпиской не отображается премиум-статус, вместо этого показывается «Бесплатный доступ». Это происходит несмотря на то, что в базе данных есть запись об активной подписке с флагом `is_active = TRUE` и действующими датами.

В консоли выдается ошибка:
```
SubscriptionWidget.tsx:206 Попытка запроса статуса подписки без валидного userId
```

Основная проблема заключалась в неправильном прохождении ID пользователя в компонентах и API-запросах, а также в маршрутизации API, из-за чего клиент получал HTML-страницу вместо JSON-ответа.

## Решение проблемы

### 1. Улучшение API-эндпоинта для получения статуса подписки

Создан высокоприоритетный API-эндпоинт `/force-premium-status/{user_id}`, который:
- Напрямую обращается к базе данных для проверки статуса подписки
- Игнорирует SPA-маршрутизацию, чтобы гарантированно возвращать JSON, а не HTML
- Добавляет заголовки для предотвращения кэширования
- Проверяет наличие активной подписки для любого пользователя

```python
@app.get("/force-premium-status/{user_id}", include_in_schema=True)
async def force_premium_status(user_id: str):
    """
    Прямая проверка премиум-статуса по ID пользователя без использования ORM.
    Этот метод имеет максимальный приоритет перед SPA-обработчиком.
    """
    try:
        # ... проверка наличия активной подписки в БД ...
        
        query = """
        SELECT COUNT(*) 
        FROM subscriptions 
        WHERE user_id = $1 
          AND is_active = TRUE 
          AND end_date > NOW()
        """
        count = await conn.fetchval(query, user_id_int)
        has_premium = count > 0
        
        # ... возврат результата ...
    except Exception as e:
        # ... обработка ошибок ...
```

### 2. Проверка и валидация ID пользователя во фронтенде

Исправлена логика получения и обработки ID пользователя:

1. В компоненте App добавлено получение userId из Telegram WebApp:
```jsx
useEffect(() => {
  if (window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
    const telegramUserId = String(window.Telegram.WebApp.initDataUnsafe.user.id);
    console.log(`[App] Получен user_id из Telegram WebApp: ${telegramUserId}`);
    setUserId(telegramUserId);
    setIsAuthenticated(true);
  }
}, []);
```

2. В компоненте SubscriptionWidget улучшена проверка validatedUserId:
```jsx
const fetchSubscriptionStatus = async () => {
  if (!validatedUserId) {
    console.log('Невозможно запросить статус подписки без валидного userId');
    return;
  }
  
  // ... получение статуса подписки ...
};

// Вызываем функцию только если есть validatedUserId
if (validatedUserId) {
  fetchSubscriptionStatus();
  // ... обновление по интервалу ...
}
```

3. В компоненте DirectPremiumStatus добавлена проверка:
```jsx
if (!userId) {
  console.log('[DirectStatus] Отсутствует userId, статус не может быть проверен');
  setLoading(false);
  setError('ID пользователя не предоставлен');
  return;
}
```

### 3. Улучшение API-клиента для получения статуса подписки

Обновлены функции взаимодействия с API:
- Удалена привязка к тестовому ID пользователя
- Добавлена обработка ошибок с возвратом базового состояния вместо выброса исключения
- Добавлено преобразование формата ответа от API к нужному интерфейсу
- Добавлены заголовки для предотвращения кэширования

```typescript
export const getUserSubscriptionStatus = async (userId: string | null): Promise<SubscriptionStatus> => {
  if (!userId) {
    throw new Error('ID пользователя не предоставлен');
  }
  
  try {
    // Сначала пробуем прямой запрос
    try {
      return await getForcePremiumStatus(userId);
    } catch (forceError) {
      console.warn("Не удалось использовать прямой запрос...", forceError);
    }
    
    // Затем стандартный API
    // ... запрос с заголовками ...
  } catch (error) {
    // Обработка ошибок с возвратом базового состояния
    return {
      has_subscription: false,
      analysis_count: 1,
      post_generation_count: 1
    };
  }
};
```

## Тестирование и проверка

Для проверки корректности работы решения рекомендуется:

1. Проверить передачу ID пользователя через консоль браузера 
2. Убедиться, что API-запрос возвращает JSON, а не HTML (через Network tab)
3. Проверить корректность запроса к базе данных через отладочную информацию
4. Проверить наличие активной подписки в базе данных для конкретного пользователя

## Дополнительные рекомендации

1. Регулярно проверяйте наличие активных подписок в базе данных
2. Обратите внимание на временные зоны при сравнении дат
3. Используйте отладочную информацию в компонентах для диагностики проблем
4. При необходимости включите дополнительное логирование на сервере для отслеживания запросов 