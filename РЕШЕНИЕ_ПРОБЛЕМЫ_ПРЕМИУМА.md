# Решение проблемы с премиум-подпиской

В этом документе описаны шаги по решению проблемы с определением премиум-статуса подписки пользователя.

## Выявленные проблемы

1. **Проблема с данными в базе**: возможно, запись в таблице `user_subscription` некорректная, или `is_active` и `end_date` не соответствуют ожиданиям.
2. **Кэширование**: браузер или приложение могут кэшировать старые данные о подписке.
3. **Ошибка на фронтенде**: виджет подписки не обновляется или некорректно отображает статус.
4. **Проблема с user_id**: фронтенд может использовать неправильный ID пользователя.
5. **Неактуальная кодовая база**: используемый код может отличаться от ожидаемого.

## Решения

### 1. Проверка состояния подписки в базе данных

Запустите диагностический скрипт для проверки записей:

```bash
python check_subscription.py
```

Этот скрипт выведет все подписки для указанного пользователя и проверит, являются ли они активными.

### 2. Исправление данных в базе 

Если диагностика показала проблемы, запустите скрипт для исправления:

```bash
python fix_subscription.py
```

Для проверки без исправления используйте:

```bash
python fix_subscription.py --check
```

### 3. Обновление бэкенда

Мы улучшили метод `get_subscription` в `services/subscription_service.py` для более надежной проверки подписок:

- Метод теперь сначала проверяет `is_active = TRUE`, затем отдельно проверяет `end_date > NOW()`
- Если найдена подписка с истекшим сроком, она автоматически деактивируется
- Если найдена подписка с `is_active = FALSE`, но не истекшим сроком, она активируется

### 4. Обновление фронтенда

Фронтенд также улучшен для более надежного определения ID пользователя и обхода кэширования:

- В API-клиенте добавлены заголовки для предотвращения кэширования
- В компоненте `SubscriptionWidget` добавлена проверка и валидация ID пользователя
- Добавлено периодическое обновление статуса подписки
- Добавлено отображение текущего ID пользователя для диагностики

### 5. Ручное обновление премиум-статуса

Если автоматические методы не помогают, выполните следующие SQL-запросы непосредственно в базе данных:

```sql
-- Узнать текущее время на сервере
SELECT NOW();

-- Проверить все подписки пользователя
SELECT * FROM user_subscription WHERE user_id = 427032240;

-- Активировать существующую подписку
UPDATE user_subscription 
SET is_active = TRUE, end_date = NOW() + INTERVAL '1 month', updated_at = NOW()
WHERE id = 3; -- ID из предыдущего запроса

-- Создать новую подписку, если необходимо
INSERT INTO user_subscription
(user_id, start_date, end_date, is_active, payment_id)
VALUES 
(427032240, NOW(), NOW() + INTERVAL '1 month', TRUE, 'manual_fix_'||extract(epoch from now())::int)
RETURNING *;
```

## После исправления

1. Перезапустите сервер для применения изменений в бэкенде
2. Очистите кэш в браузере пользователя
3. Перезагрузите страницу для обновления виджета подписки
4. Проверьте консоль разработчика на наличие ошибок

## Долгосрочные улучшения

1. Добавить более подробное логирование для отслеживания подписок
2. Реализовать автоматическую синхронизацию подписок
3. Добавить административный интерфейс для управления подписками
4. Настроить мониторинг ошибок, связанных с подписками 